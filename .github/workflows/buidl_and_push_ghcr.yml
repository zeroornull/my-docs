name: Build and Deploy (Buildah in DinD)

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: gitea-actions-act-runner-0
    # ⚠️ 关键点 1: 在 DinD 模式下，不要指定 container: image
    # 直接使用 Runner 默认的环境 (通常是 catthehacker/ubuntu 或类似)，它自带了 Node.js
    
    env:
      REGISTRY: gitea.173114.xyz
      IMAGE_NAME: gitea_admin/my-docs
      # ⚠️ 关键点 2: 即使有特权，在容器里跑 Buildah 依然建议用 vfs
      # 因为 overlayfs 不支持在容器里嵌套运行 (除非宿主机做了特殊配置)
      STORAGE_DRIVER: vfs
      BUILDAH_FORMAT: docker

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        # 这里不需要手动安装 Node.js，因为默认 Runner 镜像里都有

      - name: Install Buildah & QEMU
        run: |
          # ⚠️ 关键点 3: 在 Ubuntu (默认 Runner) 上安装 Buildah
          # 确保更新源，防止找不到包
          sudo apt-get update
          sudo apt-get install -y buildah qemu-user-static

      - name: Log in to Gitea Registry
        run: |
          buildah login -u ${{ secrets.ADMIN_USERNAME }} -p ${{ secrets.PACKAGES_TOKEN }} ${{ env.REGISTRY }}

      # --- 下面这几步和之前一样 (构建 -> 推送 -> 合并) ---

      - name: Build and Push AMD64
        run: |
          buildah build --platform linux/amd64 \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:amd64 \
            -f Dockerfile .
          buildah push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:amd64

      - name: Build and Push ARM64
        run: |
          buildah build --platform linux/arm64 \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:arm64 \
            -f Dockerfile .
          buildah push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:arm64

      - name: Create and Push Manifest
        run: |
          MANIFEST_NAME="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          # 如果之前跑过，可能会有残留，先删一下
          buildah manifest rm $MANIFEST_NAME || true
          
          buildah manifest create $MANIFEST_NAME
          buildah manifest add $MANIFEST_NAME docker://${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:amd64
          buildah manifest add $MANIFEST_NAME docker://${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:arm64
          buildah manifest push --all $MANIFEST_NAME docker://$MANIFEST_NAME

      # --- 部署部分 ---
      
      - name: Install kubectl
        uses: azure/setup-kubectl@v3 # 既然是默认 Runner，这个官方 Action 也能直接用了
        
      - name: Deploy to Kubernetes
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBE_CONFIG }}" > ~/.kube/config
          chmod 600 ~/.kube/config
          kubectl set image deployment/my-docs nginx=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest -n dev
          kubectl rollout restart deployment/my-docs -n dev