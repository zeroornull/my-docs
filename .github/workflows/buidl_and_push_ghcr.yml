name: Docker Image CI

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    
    # ğŸŒŸ å…³é”®ç‚¹ 1: å¯åŠ¨ä¸€ä¸ª Docker å®ˆæŠ¤è¿›ç¨‹å®¹å™¨ (DinD)
    services:
      docker:
        image: docker:dind
        options: --privileged
        ports:
          - 2376:2376

    # ğŸŒŸ å…³é”®ç‚¹ 2: å‘Šè¯‰æ‰€æœ‰æ­¥éª¤é€šè¿‡ TCP è¿æ¥ Dockerï¼Œè€Œä¸æ˜¯ Socket
    env:
      DOCKER_HOST: tcp://docker:2376
      DOCKER_TLS_VERIFY: 1
      DOCKER_CERT_PATH: /certs/client
      DOCKER_TLS_CERTDIR: /certs

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ğŸŒŸ å…³é”®ç‚¹ 3: é…ç½® Buildx ä½¿ç”¨ä¸Šé¢å®šä¹‰çš„ docker å®¹å™¨é©±åŠ¨
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container
          endpoint: tcp://docker:2376

      - name: Log in to Gitea Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ gitea.server_url }}
          username: ${{ gitea.actor }}
          password: ${{ secrets.GITEA_TOKEN }}

      - name: Build and push Docker image
        run: |
          DOMAIN=$(echo "${{ gitea.server_url }}" | sed -e 's|^[^/]*//||' -e 's|/.*$||')
          REPO_LOWER=$(echo "${{ gitea.repository }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_NAME="$DOMAIN/$REPO_LOWER"

          echo "Pushing to: $IMAGE_NAME"
          
          docker build . --file Dockerfile \
            --tag "$IMAGE_NAME:latest" \
            --tag "$IMAGE_NAME:${{ gitea.sha }}"
          
          docker push "$IMAGE_NAME:latest"
          docker push "$IMAGE_NAME:${{ gitea.sha }}"