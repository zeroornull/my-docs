name: Gitea CI/CD for Helm Deployment

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Docker Environment (Rootless/Dind)
        id: docker-env
        run: |
          echo "ðŸ” Checking Docker environment..."
          echo "User: $(whoami) (UID: $(id -u))"
          
          # å®šä¹‰å¯èƒ½çš„ Socket è·¯å¾„
          SOCKET_PATHS=(
            "/var/run/docker.sock"
            "/run/docker.sock"
            "/run/user/$(id -u)/docker.sock"
            "/run/user/1000/docker.sock"
          )
          
          FOUND_SOCKET=""
          
          for path in "${SOCKET_PATHS[@]}"; do
            if [ -S "$path" ]; then
              echo "âœ… Found Docker socket at: $path"
              FOUND_SOCKET="unix://$path"
              break
            fi
          done
          
          if [ -z "$FOUND_SOCKET" ]; then
            echo "âš ï¸ No Docker socket found in common locations."
            echo "Listing /run/user if available:"
            ls -R /run/user || echo "/run/user not accessible"
          else
            echo "DOCKER_HOST=$FOUND_SOCKET" >> $GITHUB_ENV
            echo "Setting DOCKER_HOST to $FOUND_SOCKET"
          fi

      - name: Verify Docker Connection
        run: |
          echo "ðŸ³ Verifying Docker connection..."
          if docker info > /dev/null 2>&1; then
            echo "âœ… Docker is reachable!"
            docker info
          else
            echo "âŒ Cannot connect to Docker daemon."
            echo "Current DOCKER_HOST: $DOCKER_HOST"
            # å¦‚æžœé•œåƒé‡Œæœ‰ dind ä½†æ²¡å¯åŠ¨ï¼Œè¿™é‡Œå¯èƒ½ä¼šå¤±è´¥ã€‚
            # ä½†é€šå¸¸ Gitea Runner çš„ dind æ¨¡å¼ä¼šè‡ªåŠ¨æŒ‚è½½ socketã€‚
            exit 1
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Gitea Container Registry
        uses: docker/login-action@v3
        with:
          registry: gitea.example.com
          username: ${{ gitea.actor }}
          password: ${{ secrets.GITEA_TOKEN }}

      - name: Build and push Docker image
        run: |
          IMAGE_NAME="gitea.example.com/${{ gitea.owner }}/my-docs"
          echo "Pushing to: $IMAGE_NAME"
          docker build . --file Dockerfile \
            --tag "$IMAGE_NAME:latest" \
            --tag "$IMAGE_NAME:${{ gitea.sha }}"
          docker push "$IMAGE_NAME:latest"
          docker push "$IMAGE_NAME:${{ gitea.sha }}"

  deploy:
    runs-on: ubuntu-latest 
    needs: build-and-push
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Kubeconfig
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG }}" > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
        if: ${{ secrets.KUBE_CONFIG != '' }}

      - name: Set up Helm
        uses: azure/setup-helm@v3
        with:
          version: 'latest'

      - name: Deploy with Helm
        run: |
          IMAGE_NAME="gitea.example.com/${{ gitea.owner }}/my-docs"
          helm upgrade --install my-docs-release ./helm/my-docs \
            --namespace my-docs-ns \
            --create-namespace \
            --set image.repository="$IMAGE_NAME" \
            --set image.tag="${{ gitea.sha }}"
