name: Gitea Docker Image CI
run-name: Build and Push to Gitea Registry

on:
  workflow_dispatch:  # 保留手动触发
  push:               # push 事件触发
    branches:
      - main          # 当推送代码到 main 分支时触发

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. 生成认证配置
      # 这里的逻辑替代了 docker/login-action
      # 我们将 Gitea 自动提供的 Token 写入 Kaniko 需要的 config.json 中
      - name: Create Kaniko Credentials
        run: |
          mkdir -p $HOME/.docker
          # 提取 Gitea 的域名 (去掉 http/https 前缀)
          DOMAIN=$(echo "${{ gitea.server_url }}" | awk -F/ '{print $3}')
          # 生成认证文件
          echo "{\"auths\":{\"$DOMAIN\":{\"username\":\"${{ gitea.actor }}\",\"password\":\"${{ secrets.GITHUB_TOKEN }}\"}}}" > $HOME/.docker/config.json

      # 2. 准备镜像名称变量 (处理大小写)
      # 这一步是为了防止用户名或仓库名有大写字母导致构建失败
      - name: Prepare Image Name
        id: prep
        run: |
          # 将 gitea.repository (格式: owner/repo) 转换为全小写
          IMAGE_NAME=$(echo "${{ gitea.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "image_name=$IMAGE_NAME" >> $GITHUB_OUTPUT

      # 3. 使用 Kaniko 构建并推送
      # 替代了 setup-buildx, build 和 push
      - name: Build and Push with Kaniko
        uses: docker://gcr.io/kaniko-project/executor:debug
        env:
          # 指定 Kaniko 使用我们在第一步生成的认证文件
          DOCKER_CONFIG: /github/home/.docker
        with:
          # 相当于 docker build . --file Dockerfile
          # destination 对应 docker push
          args: >-
            --context .
            --dockerfile ./Dockerfile
            --destination ${{ gitea.server_url }}/${{ steps.prep.outputs.image_name }}:latest
            --destination ${{ gitea.server_url }}/${{ steps.prep.outputs.image_name }}:${{ gitea.sha }}
            --force
            --cache=true