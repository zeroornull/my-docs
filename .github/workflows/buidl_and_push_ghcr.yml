name: Build and Deploy (Kaniko Multi-Arch)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 注册 QEMU 以支持 ARM64 构建 (需要 Runner 支持特权容器)
      - name: Setup QEMU
        uses: docker://tonistiigi/binfmt:qemu-v7.0.0-28
        with:
          args: --install all

      # 构建 AMD64 镜像
      - name: Build AMD64
        uses: docker://gcr.io/kaniko-project/executor:v1.23.2-debug
        with:
          entrypoint: /busybox/sh
          args: >-
            -c
            "
            HOST='gitea-http.gitea.svc.cluster.local:3000';
            RAW_USER='${{ gitea.actor }}';
            LOWER_USER=$(echo $RAW_USER | tr '[:upper:]' '[:lower:]');
            PASS='${{ secrets.PACKAGES_TOKEN }}';
            AUTH_STR=$(echo -n \"${RAW_USER}:${PASS}\" | base64 | tr -d '\n');
            
            echo \"{\\\"auths\\\":{\\\"\$HOST\\\":{\\\"auth\\\":\\\"\$AUTH_STR\\\"}}}\" > /kaniko/.docker/config.json;
            
            /kaniko/executor --context=. --dockerfile=Dockerfile --destination=\$HOST/\$LOWER_USER/my-docs:${{ github.sha }}-amd64 --customPlatform=linux/amd64 --insecure --skip-tls-verify --cache=true
            "

      # 构建 ARM64 镜像
      - name: Build ARM64
        uses: docker://gcr.io/kaniko-project/executor:v1.23.2-debug
        with:
          entrypoint: /busybox/sh
          args: >-
            -c
            "
            HOST='gitea-http.gitea.svc.cluster.local:3000';
            RAW_USER='${{ gitea.actor }}';
            LOWER_USER=$(echo $RAW_USER | tr '[:upper:]' '[:lower:]');
            PASS='${{ secrets.PACKAGES_TOKEN }}';
            AUTH_STR=$(echo -n \"${RAW_USER}:${PASS}\" | base64 | tr -d '\n');
            
            echo \"{\\\"auths\\\":{\\\"\$HOST\\\":{\\\"auth\\\":\\\"\$AUTH_STR\\\"}}}\" > /kaniko/.docker/config.json;
            
            /kaniko/executor --context=. --dockerfile=Dockerfile --destination=\$HOST/\$LOWER_USER/my-docs:${{ github.sha }}-arm64 --customPlatform=linux/arm64 --insecure --skip-tls-verify --cache=true
            "

      # 合并 Manifest 并推送
      - name: Push Manifest List
        uses: docker://mplatform/manifest-tool:alpine
        with:
          entrypoint: /bin/sh
          args: >-
            -c
            "
            HOST='gitea-http.gitea.svc.cluster.local:3000';
            RAW_USER='${{ gitea.actor }}';
            LOWER_USER=$(echo $RAW_USER | tr '[:upper:]' '[:lower:]');
            PASS='${{ secrets.PACKAGES_TOKEN }}';
            AUTH_STR=$(echo -n \"${RAW_USER}:${PASS}\" | base64 | tr -d '\n');
            
            mkdir -p ~/.docker;
            echo \"{\\\"auths\\\":{\\\"\$HOST\\\":{\\\"auth\\\":\\\"\$AUTH_STR\\\"}}}\" > ~/.docker/config.json;

            echo '>>> Pushing Manifest for SHA tag';
            manifest-tool push from-args \
              --platforms linux/amd64,linux/arm64 \
              --template \$HOST/\$LOWER_USER/my-docs:${{ github.sha }}-ARCH \
              --target \$HOST/\$LOWER_USER/my-docs:${{ github.sha }} \
              --insecure;

            echo '>>> Pushing Manifest for latest tag';
            manifest-tool push from-args \
              --platforms linux/amd64,linux/arm64 \
              --template \$HOST/\$LOWER_USER/my-docs:${{ github.sha }}-ARCH \
              --target \$HOST/\$LOWER_USER/my-docs:latest \
              --insecure;
            "

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Kubernetes
        uses: docker://bitnami/kubectl:latest
        env:
          KUBECONFIG_BASE64: ${{ secrets.KUBE_CONFIG_TEST }}
          HOST: gitea.173114.xyz
          RAW_USER: ${{ gitea.actor }}
          IMAGE_TAG: ${{ github.sha }}
        with:
          entrypoint: /bin/sh
          args: >-
            -c
            "
            set -xe;
            
            echo '>>> Step 1: Checking Environment';
            if [ -z \"$KUBECONFIG_BASE64\" ]; then
              echo 'Error: KUBECONFIG_BASE64 is empty! Check Gitea Secrets.';
              exit 1;
            fi;

            echo '>>> Step 2: Decoding Kubeconfig';
            echo \"$KUBECONFIG_BASE64\" | base64 -d > /tmp/kubeconfig;
            export KUBECONFIG=/tmp/kubeconfig;

            echo '>>> Step 3: Verifying Cluster Connection';
            kubectl cluster-info;
            
            echo '>>> Step 4: Preparing Image Name';
            LOWER_USER=$(echo $RAW_USER | tr '[:upper:]' '[:lower:]');
            FULL_IMAGE=\"$HOST/$LOWER_USER/my-docs:$IMAGE_TAG\";
            echo \"Target Image: $FULL_IMAGE\";

            echo '>>> Step 5: Executing Deployment';
            kubectl set image deployment/my-docs nginx=$FULL_IMAGE -n dev;

            echo '>>> Step 6: Restarting and Waiting';
            kubectl rollout restart deployment/my-docs -n dev;
            kubectl rollout status deployment/my-docs -n dev;
            "
